<div *ngIf="!accountService.jsonData" class="container" fxLayout="column" fxLayoutAlign="start center"
     fxLayoutGap="15px" style="height: calc(100vh - 209px);">
  <mat-card style="width: 100%;">
    <h1 class="faded">
      <fa-icon [icon]="faSadTear" style="margin-right: 5px"></fa-icon>
      Account not found
    </h1>
    <div>We couldn't find the account <strong>{{accountName}}</strong></div>
  </mat-card>
</div>

<div *ngIf="accountService.jsonData" class="container" fxLayout="column" fxLayoutAlign="start center"
     fxLayoutGap="15px">

  <mat-card fxFlex="100" fxFlexFill>
    <h2 style="letter-spacing: 1px;">
      <fa-icon [icon]="faUserCircle" style="margin-right: 5px"></fa-icon>
      {{accountService.account['account_name']}}
    </h2>
    <p><strong>Liquid Balance: {{accountService.account['core_liquid_balance']}}</strong></p>
    <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap.gt-xs="30px" fxLayoutGap.lt-sm="40px">
      <div fxFlex="0 0 calc((100% - 132px) / 3)">
        <div><span class="title">RAM</span>
          <span class="faded used" [ngClass.lt-sm]="'display-block'">{{(accountService.account['ram_usage'] /
            accountService.account['ram_quota']) *
          100 | number}}% used</span>
        </div>
        <div class="values">{{convertBytes(accountService.account['ram_usage'])}} / {{convertBytes(accountService.account['ram_quota'])}}
        </div>
        <mat-progress-bar class="progress-bar" mode="determinate"
                          [value]="(accountService.account['ram_usage'] / accountService.account['ram_quota']) * 100"></mat-progress-bar>
      </div>
      <div fxFlex="0 0 calc((100% - 132px) / 3)">
        <div>
          <span class="title">CPU</span>
          <span [ngClass.lt-sm]="'display-block'"
                class="faded used">{{(accountService.account['cpu_limit']['used'] /
            accountService.account['cpu_limit']['max']) * 100 | number}}% used</span>
        </div>
        <div class="values">{{convertMicroS(accountService.account['cpu_limit']['used'])}}
          / {{convertMicroS(accountService.account['cpu_limit']['max'])}}
        </div>
        <mat-progress-bar class="progress-bar" mode="determinate"
                          [value]="(accountService.account['cpu_limit']['used'] / accountService.account['cpu_limit']['max']) * 100"></mat-progress-bar>
      </div>
      <div fxFlex="0 0 calc((100% - 132px) / 3)">
        <div>
          <span class="title">NET</span>
          <span [ngClass.lt-sm]="'display-block'"
                class="faded used">{{(accountService.account['net_limit']['used'] /
            accountService.account['net_limit']['max']) * 100 | number}}% used</span>
        </div>
        <div class="values">{{convertBytes(accountService.account['net_limit']['used'])}}
          / {{convertBytes(accountService.account['net_limit']['max'])}}
        </div>
        <mat-progress-bar class="progress-bar" mode="determinate"
                          [value]="(accountService.account['net_limit']['used'] / accountService.account['net_limit']['max']) * 100"></mat-progress-bar>
      </div>
    </div>
  </mat-card>

  <div fxLayout.gt-sm="row" fxLayoutAlign.gt-sm="space-between"
       fxLayout.lt-md="column" fxLayoutAlign.lt-md="start auto"
       fxLayoutGap="10px" fxFlexFill fxFlex="auto">

    <mat-card fxFlex.gt-sm="25" ngClass.gt-sm="middle-card">
      <h3>
        <fa-layers [fixedWidth]="true" style="margin-right: 5px">
          <fa-icon [icon]="faCircle" transform="grow-3"></fa-icon>
          <fa-icon [icon]="faStar" [inverse]="true" transform="shrink-5"></fa-icon>
        </fa-layers>
        Tokens
      </h3>

      <div fxLayout.lt-md="row wrap" fxLayoutAlign.lt-md="start stretch"
           fxLayoutGap.lt-md="43px"
           fxLayoutGap.lt-sm="60px">

        <div *ngFor="let token of accountService.tokens"
             fxFlex.sm="0 0 calc((100% - 132px) / 3)"
             fxFlex.xs="0 0 calc((100% - 132px) / 2)">
          <div class="token-cell">
            <div class="faded monospace div-link"
                 [routerLink]="['/account', token.contract]">{{token.contract}}</div>
            <div class="token-amount" [ngClass.lt-sm]="'break-word'">{{token.amount | number :'1.0-' +
            (token.precision || 4)}}
              <span class="token">{{token.symbol}}</span>
            </div>
          </div>
        </div>
      </div>
    </mat-card>

    <mat-card fxFlex.gt-sm="75" ngClass.gt-sm="middle-card">

      <h3>
        <fa-layers [fixedWidth]="true" style="margin-right: 5px">
          <fa-icon [icon]="faCircle" transform="grow-3"></fa-icon>
          <fa-icon [icon]="faLink" [inverse]="true" transform="shrink-5"></fa-icon>
        </fa-layers>
        Permissions & Keys
      </h3>

      <mat-tree [dataSource]="dataSource" [treeControl]="treeControl">
        <!-- This is the tree node template for leaf nodes -->

        <mat-tree-node *matTreeNodeDef="let node" matTreeNodePadding>
          <!-- use a disabled button to provide padding for tree leaf -->
          <button mat-icon-button disabled></button>
          <div fxLayout="column" fxLayoutGap="7px" class="permission-cell">
            <div><h3 class="primary" style="display: inline; letter-spacing: 0.7px;">{{node.perm_name}}</h3></div>
            <ng-container *ngIf="node['required_auth']['keys'].length > 0">
              <div *ngFor="let key of node['required_auth']['keys']">
                <div>
                  <strong class="space-right" matTooltip="weight / threshold" matTooltipClass="tooltip-bigger">
                    {{key.weight}}/{{node.required_auth.threshold}}
                  </strong>
                  <fa-icon [icon]="faKey"></fa-icon>
                  <a [routerLink]="['/key', key.key]" class="monospace m-left break-word link-gray">{{key.key}}
                  </a>
                </div>
              </div>
            </ng-container>
            <ng-container *ngIf="node['required_auth']['accounts'].length > 0">
              <div *ngFor="let acc of node['required_auth']['accounts']">
                <strong class="space-right" matTooltip="weight / threshold" matTooltipClass="tooltip-bigger">
                  {{acc.weight}}/{{node.required_auth.threshold}}
                </strong>
                <fa-icon [icon]="faUser"></fa-icon>
                <a [routerLink]="['/account', acc.permission.actor]"
                   class="m-left link-blue">{{acc.permission.actor}}</a>@{{acc['permission'].permission}}
              </div>
            </ng-container>
            <ng-container *ngIf="node['required_auth']['waits'].length > 0">
              <div *ngFor="let waits of node['required_auth']['waits']">
                <strong class="space-right" matTooltip="weight / threshold" matTooltipClass="tooltip-bigger">
                  {{waits.weight}}/{{node.required_auth.threshold}}
                </strong>
                <fa-icon [icon]="faClock"></fa-icon>
                <span class="m-left">{{waits.wait_sec}}s</span>
              </div>
            </ng-container>
          </div>
        </mat-tree-node>

        <!-- This is the tree node template for expandable nodes -->
        <!--suppress AngularUndefinedBinding -->
        <mat-tree-node *matTreeNodeDef="let node; when: hasChild" matTreeNodePadding>
          <button mat-icon-button matTreeNodeToggle>
            <fa-icon [icon]="treeControl.isExpanded(node) ? faChevronDown : faChevronRight"></fa-icon>
          </button>
          <div fxLayout="column" fxLayoutGap="7px" class="permission-cell">
            <div><h3 class="primary" style="display: inline; letter-spacing: 0.7px;">{{node.perm_name}}</h3></div>
            <ng-container *ngIf="node['required_auth']['keys'].length > 0">
              <div *ngFor="let key of node['required_auth']['keys']">
                <div>
                  <strong class="space-right" matTooltip="weight / threshold" matTooltipClass="tooltip-bigger">
                    {{key.weight}}/{{node.required_auth.threshold}}
                  </strong>
                  <fa-icon [icon]="faKey"></fa-icon>
                  <a [routerLink]="['/key', key.key]" class="monospace m-left break-word link-gray">{{key.key}}
                  </a>
                </div>
              </div>
            </ng-container>
            <ng-container *ngIf="node['required_auth']['accounts'].length > 0">
              <div *ngFor="let acc of node['required_auth']['accounts']">
                <strong class="space-right" matTooltip="weight / threshold" matTooltipClass="tooltip-bigger">
                  {{acc.weight}}/{{node.required_auth.threshold}}
                </strong>
                <fa-icon [icon]="faUser"></fa-icon>
                <a [routerLink]="['/account', acc.permission.actor]"
                   class="m-left link-blue">{{acc.permission.actor}}</a>@{{acc.permission.permission}}
              </div>
            </ng-container>
            <ng-container *ngIf="node['required_auth']['waits'].length > 0">
              <div *ngFor="let waits of node['required_auth']['waits']">
                <strong class="space-right" matTooltip="weight / threshold" matTooltipClass="tooltip-bigger">
                  {{waits.weight}}/{{node.required_auth.threshold}}
                </strong>
                <fa-icon [icon]="faClock"></fa-icon>
                <span class="m-left">{{waits.wait_sec}}s</span>
              </div>
            </ng-container>
          </div>
        </mat-tree-node>
      </mat-tree>
    </mat-card>
  </div>

  <mat-card fxFlexFill fxFlex="100">
    <div fxLayout="row" fxLayoutAlign="space-between start">
      <h3 style="margin-top: 0;">
        <fa-layers [fixedWidth]="true" style="margin-right: 5px">
          <fa-icon [icon]="faCircle" transform="grow-3"></fa-icon>
          <fa-icon [icon]="faHistory" [inverse]="true" transform="shrink-5"></fa-icon>
        </fa-layers>
        Actions
      </h3>

      <div (click)="accountService.toggleStreaming()" class="livestream" matTooltip="click to turn on/off"
           matTooltipClass="tooltip-bigger">
        action live streaming <span class="w-500">{{accountService.streamClientStatus ? 'enabled' : 'disabled'}}</span>
        <span class="dot" [ngClass]="{'pulse': accountService.streamClientStatus, 'red-dot': !accountService.streamClientStatus}"></span>
      </div>
    </div>
    <table mat-table [dataSource]="accountService.tableDataSource"
           matSort
           matSortActive="block_num"
           matSortStart="desc"
           matSortDirection="desc" class="actions-table">

      <!-- TX Column -->
      <ng-container matColumnDef="trx_id">
        <th mat-header-cell *matHeaderCellDef [ngStyle.gt-xs]="{'min-width': '100px'}"> TX</th>
        <td mat-cell *matCellDef="let action" data-label="TX">
          <fa-icon [icon]="faClock" class="accent" style="margin-right: 5px"></fa-icon>
          <a [routerLink]="['/transaction', action['trx_id']]" class="link-blue">
            {{action['trx_id'].slice(0, 8)}}...
          </a>
        </td>
      </ng-container>

      <!-- Action Column -->
      <ng-container matColumnDef="action">
        <th mat-header-cell *matHeaderCellDef
            [ngStyle.gt-xs]="{'padding-left': '14px', 'padding-right':'14px','min-width': '100px'}"
            [ngStyle.gt-sm]="{'min-width': '240px'}">
          Action
        </th>
        <td mat-cell *matCellDef="let action" [ngStyle.gt-xs]="{'padding-left': '14px', 'padding-right':'14px'}"
            data-label="Action">
          <span class="action-cell" [ngStyle.lt-md]="{'padding':'0'}" [ngClass.gt-sm]="'action-border'">
            <span class="accent w-500">{{action['act']['name']}}</span> on
            <span [routerLink]="['/account', action['act']['account']]" class="w-500 div-link">
              {{action['act']['account']}}
            </span>
          </span>
        </td>
      </ng-container>

      <!-- Data Column -->
      <ng-container matColumnDef="data">
        <th mat-header-cell *matHeaderCellDef> Data</th>
        <td mat-cell *matCellDef="let action" [ngStyle.gt-xs]="{'padding': '10px 10px 7px 0'}" data-label="Data">

          <!-- DETAILED ACTION DATA VIEW-->
          <ng-container *ngIf="detailedView">

            <div *ngFor="let item of action['act']['data'] | keyvalue"
                 [ngClass]="{'data-item': objectKeyCount(action['act']['data']) > 1}">
              <ng-container *ngIf="isArray(item.value)">
                <span class="w-500">{{item.key}} [{{item.value.length}}]</span>:

                <div style="margin-top: 5px" *ngFor="let subitem of item.value">

                  <ng-container *ngIf="getType(subitem) === 'string'">
                    <div style="margin-left: 15px"><span class="break-word">• {{subitem}}</span></div>
                  </ng-container>

                  <ng-container *ngIf="getType(subitem) === 'object'">
                    <div *ngFor="let elem of subitem | keyvalue" [ngClass]="{'data-item': objectKeyCount(subitem) > 1}">
                    <span class="w-500" style="margin-left: 15px">
                      {{elem.key}}</span>: <span class="break-word">{{elem.value}}</span>
                    </div>
                  </ng-container>

                </div>

              </ng-container>

              <ng-container *ngIf="!isArray(item.value)">
                <span class="w-500">{{item.key}}</span>:
                <span *ngIf="item.value" class="break-word">{{item.value}}</span>
                <span *ngIf="!item.value" class="break-word" style="font-style: italic">empty</span>
              </ng-container>

            </div>

            <span *ngIf="getType(action['act']['data'])=== 'string'" class="break-word" style="font-style: italic">
              {{action['act']['data']}}
            </span>

          </ng-container>

          <ng-container *ngIf="!detailedView">

          </ng-container>
        </td>
      </ng-container>

      <!-- Block & Date Column -->
      <ng-container matColumnDef="block_num">
        <th mat-header-cell *matHeaderCellDef mat-sort-header [ngStyle.gt-xs]="{'min-width': '70px'}">Block & Date</th>
        <td mat-cell *matCellDef="let action" data-label="Block & Date">
          <a [routerLink]="['/block', action['block_num']]" class="link-blue">{{action['block_num']}}</a>
          <br>
          <span> {{formatDate(action['@timestamp'])}}</span>
        </td>
      </ng-container>

      <!--suppress AngularUndefinedBinding -->
      <tr mat-header-row *matHeaderRowDef="columnsToDisplay; sticky: true"></tr>

      <!--suppress AngularUndefinedBinding -->
      <tr mat-row *matRowDef="let myRowData; columns: columnsToDisplay"></tr>
    </table>
    <mat-paginator [pageSizeOptions]="[10, 5, 50]" [length]="accountService.tableDataSource.filteredData.length" showFirstLastButtons></mat-paginator>

  </mat-card>

</div>

